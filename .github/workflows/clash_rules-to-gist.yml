name: Sync Clash Rules Files to Gist

on:
  push:
    paths:
      - '**.list'  # ç›‘æ§æ‰€æœ‰ .list æ–‡ä»¶ï¼ˆåŒ…æ‹¬å­ç›®å½•ï¼‰
    branches:
      - main
  
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºæ£€æµ‹åˆ é™¤çš„æ–‡ä»¶
          persist-credentials: false
      
      - name: é…ç½® Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
      
      - name: å…‹éš† Gist
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: ${{ secrets.CLASH_RULES_GIST_ID }}
        run: |
          git clone https://${GIST_TOKEN}@gist.github.com/${GIST_ID}.git gist-repo
      
      - name: æ™ºèƒ½åŒæ­¥ï¼ˆè‡ªåŠ¨æ£€æµ‹å¢åˆ æ”¹ï¼‰
        run: |
          echo "=========================================="
          echo "ğŸ” å¼€å§‹æ™ºèƒ½åŒæ­¥ .list æ–‡ä»¶"
          echo "=========================================="
          echo ""
          
          # ===== ç¬¬ä¸€æ­¥ï¼šå¤åˆ¶æ‰€æœ‰å½“å‰å­˜åœ¨çš„ .list æ–‡ä»¶ =====
          echo "ğŸ“‹ æ­¥éª¤ 1: æ‰«æå¹¶å¤åˆ¶æ‰€æœ‰ .list æ–‡ä»¶"
          echo ""
          
          COPIED_COUNT=0
          
          # æŸ¥æ‰¾æ‰€æœ‰ .list æ–‡ä»¶ï¼ˆæ’é™¤ gist-repo ç›®å½•ï¼‰
          find . -name "*.list" -not -path "./gist-repo/*" -not -path "./.git/*" | while read file; do
            # è·å–æ–‡ä»¶åï¼ˆä¸å«è·¯å¾„ï¼‰
            filename=$(basename "$file")
            
            # å¤åˆ¶åˆ° gist-repo
            cp "$file" "gist-repo/$filename"
            echo "  âœ“ å·²åŒæ­¥: $filename"
            COPIED_COUNT=$((COPIED_COUNT + 1))
          done
          
          # ç»Ÿè®¡å¤åˆ¶çš„æ–‡ä»¶æ•°
          ACTUAL_COPIED=$(find . -name "*.list" -not -path "./gist-repo/*" -not -path "./.git/*" | wc -l)
          echo ""
          echo "  ğŸ“Š å…±å¤åˆ¶ $ACTUAL_COPIED ä¸ª .list æ–‡ä»¶"
          echo ""
          
          # ===== ç¬¬äºŒæ­¥ï¼šåˆ é™¤ Gist ä¸­å¤šä½™çš„æ–‡ä»¶ =====
          echo "ğŸ—‘ï¸  æ­¥éª¤ 2: æ¸…ç† Gist ä¸­å·²åˆ é™¤çš„æ–‡ä»¶"
          echo ""
          
          DELETED_COUNT=0
          
          # æ£€æŸ¥ Gist ä¸­çš„æ¯ä¸ª .list æ–‡ä»¶
          cd gist-repo
          for gist_file in *.list 2>/dev/null; do
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦çœŸå®å­˜åœ¨ï¼ˆä¸æ˜¯é€šé…ç¬¦æœ¬èº«ï¼‰
            [ -e "$gist_file" ] || continue
            
            # æ£€æŸ¥è¯¥æ–‡ä»¶æ˜¯å¦åœ¨æºä»“åº“ä¸­å­˜åœ¨
            if [ ! -f "../$gist_file" ]; then
              rm -f "$gist_file"
              echo "  âœ— å·²åˆ é™¤: $gist_file ï¼ˆæºä»“åº“ä¸­å·²ä¸å­˜åœ¨ï¼‰"
              DELETED_COUNT=$((DELETED_COUNT + 1))
            fi
          done
          cd ..
          
          if [ $DELETED_COUNT -eq 0 ]; then
            echo "  â„¹ï¸  æ— éœ€åˆ é™¤æ–‡ä»¶"
          else
            echo ""
            echo "  ğŸ“Š å…±åˆ é™¤ $DELETED_COUNT ä¸ªè¿‡æ—¶æ–‡ä»¶"
          fi
          
          echo ""
          echo "=========================================="
          echo "âœ… æ™ºèƒ½åŒæ­¥å®Œæˆ"
          echo "=========================================="
      
      - name: æ˜¾ç¤ºåŒæ­¥ç»“æœ
        working-directory: ./gist-repo
        run: |
          echo ""
          echo "ğŸ“¦ Gist ä¸­çš„æ–‡ä»¶åˆ—è¡¨ï¼š"
          echo ""
          ls -lh *.list 2>/dev/null || echo "  (æ—  .list æ–‡ä»¶)"
          echo ""
          
          FILE_COUNT=$(ls -1 *.list 2>/dev/null | wc -l)
          TOTAL_SIZE=$(du -sh . | cut -f1)
          
          echo "ğŸ“Š ç»Ÿè®¡ä¿¡æ¯ï¼š"
          echo "  æ–‡ä»¶æ•°é‡: $FILE_COUNT"
          echo "  æ€»å¤§å°: $TOTAL_SIZE"
      
      - name: æäº¤æ›´æ”¹
        working-directory: ./gist-repo
        run: |
          git add -A
          
          if git diff --staged --quiet; then
            echo ""
            echo "â„¹ï¸  æ²¡æœ‰å˜æ›´ï¼Œè·³è¿‡æ¨é€"
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
          else
            echo ""
            echo "ğŸ“ æ£€æµ‹åˆ°å˜æ›´ï¼Œå‡†å¤‡æäº¤..."
            
            # ç”Ÿæˆè¯¦ç»†çš„å˜æ›´ä¿¡æ¯
            ADDED=$(git diff --staged --name-only --diff-filter=A | wc -l)
            MODIFIED=$(git diff --staged --name-only --diff-filter=M | wc -l)
            DELETED=$(git diff --staged --name-only --diff-filter=D | wc -l)
            
            COMMIT_MSG="Auto-sync at $(date -u '+%Y-%m-%d %H:%M:%S UTC')

ğŸ“Š å˜æ›´ç»Ÿè®¡:
  â• æ–°å¢: $ADDED ä¸ªæ–‡ä»¶
  âœï¸  ä¿®æ”¹: $MODIFIED ä¸ªæ–‡ä»¶
  â– åˆ é™¤: $DELETED ä¸ªæ–‡ä»¶"
            
            # åˆ—å‡ºå…·ä½“å˜æ›´çš„æ–‡ä»¶
            if [ $ADDED -gt 0 ]; then
              COMMIT_MSG="$COMMIT_MSG

â• æ–°å¢æ–‡ä»¶:
$(git diff --staged --name-only --diff-filter=A | sed 's/^/  - /')"
            fi
            
            if [ $MODIFIED -gt 0 ]; then
              COMMIT_MSG="$COMMIT_MSG

âœï¸  ä¿®æ”¹æ–‡ä»¶:
$(git diff --staged --name-only --diff-filter=M | sed 's/^/  - /')"
            fi
            
            if [ $DELETED -gt 0 ]; then
              COMMIT_MSG="$COMMIT_MSG

â– åˆ é™¤æ–‡ä»¶:
$(git diff --staged --name-only --diff-filter=D | sed 's/^/  - /')"
            fi
            
            git commit -m "$COMMIT_MSG"
            echo "HAS_CHANGES=true" >> $GITHUB_ENV
          fi
      
      - name: æ¨é€åˆ° Gist
        if: env.HAS_CHANGES == 'true'
        working-directory: ./gist-repo
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: ${{ secrets.CLASH_RULES_GIST_ID }}
        run: |
          git remote set-url origin https://${GIST_TOKEN}@gist.github.com/${GIST_ID}.git
          git pull --rebase origin master || git pull --rebase origin main
          git push origin HEAD
          
          echo ""
          echo "=========================================="
          echo "ğŸ‰ æˆåŠŸæ¨é€åˆ° Gistï¼"
          echo "=========================================="
          echo ""
          echo "ğŸ“ Gist åœ°å€:"
          echo "   https://gist.github.com/${GIST_ID}"
