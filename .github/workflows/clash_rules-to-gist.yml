name: Sync Clash Rules Files to Gist

on:
  push:
    paths:
      - '**.list'
    branches:
      - main
  
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false
      
      - name: é…ç½® Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
      
      - name: å…‹éš† Gist
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: ${{ secrets.CLASH_RULES_GIST_ID }}
        run: |
          git clone https://${GIST_TOKEN}@gist.github.com/${GIST_ID}.git gist-repo
      
      - name: æ™ºèƒ½åŒæ­¥ï¼ˆè‡ªåŠ¨æ£€æµ‹å¢åˆ æ”¹ï¼‰
        run: |
          echo "=========================================="
          echo "ğŸ” å¼€å§‹æ™ºèƒ½åŒæ­¥ .list æ–‡ä»¶"
          echo "=========================================="
          echo ""
          
          # ===== ç¬¬ä¸€æ­¥ï¼šå¤åˆ¶æ‰€æœ‰å½“å‰å­˜åœ¨çš„ .list æ–‡ä»¶ =====
          echo "ğŸ“‹ æ­¥éª¤ 1: æ‰«æå¹¶å¤åˆ¶æ‰€æœ‰ .list æ–‡ä»¶"
          echo ""
          
          # æŸ¥æ‰¾æ‰€æœ‰ .list æ–‡ä»¶ï¼ˆæ’é™¤ gist-repo ç›®å½•ï¼‰
          find . -name "*.list" -not -path "./gist-repo/*" -not -path "./.git/*" | while read file; do
            filename=$(basename "$file")
            cp "$file" "gist-repo/$filename"
            echo "  âœ“ å·²åŒæ­¥: $filename"
          done
          
          ACTUAL_COPIED=$(find . -name "*.list" -not -path "./gist-repo/*" -not -path "./.git/*" | wc -l)
          echo ""
          echo "  ğŸ“Š å…±å¤åˆ¶ $ACTUAL_COPIED ä¸ª .list æ–‡ä»¶"
          echo ""
          
          # ===== ç¬¬äºŒæ­¥ï¼šåˆ é™¤ Gist ä¸­å¤šä½™çš„æ–‡ä»¶ =====
          echo "ğŸ—‘ï¸  æ­¥éª¤ 2: æ¸…ç† Gist ä¸­å·²åˆ é™¤çš„æ–‡ä»¶"
          echo ""
          
          DELETED_COUNT=0
          
          cd gist-repo
          
          # ä½¿ç”¨ ls å‘½ä»¤è·å–æ–‡ä»¶åˆ—è¡¨
          if ls *.list >/dev/null 2>&1; then
            for gist_file in *.list; do
              # æ£€æŸ¥æºä»“åº“ä¸­æ˜¯å¦å­˜åœ¨è¯¥æ–‡ä»¶
              if [ ! -f "../$gist_file" ]; then
                rm -f "$gist_file"
                echo "  âœ— å·²åˆ é™¤: $gist_file ï¼ˆæºä»“åº“ä¸­å·²ä¸å­˜åœ¨ï¼‰"
                DELETED_COUNT=$((DELETED_COUNT + 1))
              fi
            done
          fi
          
          cd ..
          
          if [ $DELETED_COUNT -eq 0 ]; then
            echo "  â„¹ï¸  æ— éœ€åˆ é™¤æ–‡ä»¶"
          else
            echo ""
            echo "  ğŸ“Š å…±åˆ é™¤ $DELETED_COUNT ä¸ªè¿‡æ—¶æ–‡ä»¶"
          fi
          
          echo ""
          echo "=========================================="
          echo "âœ… æ™ºèƒ½åŒæ­¥å®Œæˆ"
          echo "=========================================="
      
      - name: æ˜¾ç¤ºåŒæ­¥ç»“æœ
        working-directory: ./gist-repo
        run: |
          echo ""
          echo "ğŸ“¦ Gist ä¸­çš„æ–‡ä»¶åˆ—è¡¨ï¼š"
          echo ""
          
          if ls *.list >/dev/null 2>&1; then
            ls -lh *.list
          else
            echo "  (æ—  .list æ–‡ä»¶)"
          fi
          
          echo ""
          
          FILE_COUNT=$(ls -1 *.list 2>/dev/null | wc -l)
          TOTAL_SIZE=$(du -sh . | cut -f1)
          
          echo "ğŸ“Š ç»Ÿè®¡ä¿¡æ¯ï¼š"
          echo "  æ–‡ä»¶æ•°é‡: $FILE_COUNT"
          echo "  æ€»å¤§å°: $TOTAL_SIZE"
      
      - name: æäº¤æ›´æ”¹
        working-directory: ./gist-repo
        run: |
          git add -A
          
          if git diff --staged --quiet; then
            echo ""
            echo "â„¹ï¸  æ²¡æœ‰å˜æ›´ï¼Œè·³è¿‡æ¨é€"
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
          else
            echo ""
            echo "ğŸ“ æ£€æµ‹åˆ°å˜æ›´ï¼Œå‡†å¤‡æäº¤..."
            
            # ç»Ÿè®¡å˜æ›´
            ADDED=$(git diff --staged --name-only --diff-filter=A | wc -l)
            MODIFIED=$(git diff --staged --name-only --diff-filter=M | wc -l)
            DELETED=$(git diff --staged --name-only --diff-filter=D | wc -l)
            
            # åˆ›å»ºæäº¤ä¿¡æ¯
            cat > /tmp/commit_msg.txt << 'COMMIT_EOF'
          Auto-sync at $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          Changes: +${ADDED} ~${MODIFIED} -${DELETED}
          COMMIT_EOF
            
            # æ›¿æ¢å˜é‡
            sed -i "s/\$(date -u '+%Y-%m-%d %H:%M:%S UTC')/$(date -u '+%Y-%m-%d %H:%M:%S UTC')/g" /tmp/commit_msg.txt
            sed -i "s/\${ADDED}/${ADDED}/g" /tmp/commit_msg.txt
            sed -i "s/\${MODIFIED}/${MODIFIED}/g" /tmp/commit_msg.txt
            sed -i "s/\${DELETED}/${DELETED}/g" /tmp/commit_msg.txt
            
            # æ·»åŠ æ–‡ä»¶åˆ—è¡¨
            if [ $ADDED -gt 0 ]; then
              echo "" >> /tmp/commit_msg.txt
              echo "Added:" >> /tmp/commit_msg.txt
              git diff --staged --name-only --diff-filter=A | sed 's/^/  - /' >> /tmp/commit_msg.txt
            fi
            
            if [ $MODIFIED -gt 0 ]; then
              echo "" >> /tmp/commit_msg.txt
              echo "Modified:" >> /tmp/commit_msg.txt
              git diff --staged --name-only --diff-filter=M | sed 's/^/  - /' >> /tmp/commit_msg.txt
            fi
            
            if [ $DELETED -gt 0 ]; then
              echo "" >> /tmp/commit_msg.txt
              echo "Deleted:" >> /tmp/commit_msg.txt
              git diff --staged --name-only --diff-filter=D | sed 's/^/  - /' >> /tmp/commit_msg.txt
            fi
            
            # æäº¤
            git commit -F /tmp/commit_msg.txt
            rm /tmp/commit_msg.txt
            
            echo "HAS_CHANGES=true" >> $GITHUB_ENV
          fi
      
      - name: æ¨é€åˆ° Gist
        if: env.HAS_CHANGES == 'true'
        working-directory: ./gist-repo
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: ${{ secrets.CLASH_RULES_GIST_ID }}
        run: |
          git remote set-url origin https://${GIST_TOKEN}@gist.github.com/${GIST_ID}.git
          git pull --rebase origin master || git pull --rebase origin main
          git push origin HEAD
          
          echo ""
          echo "=========================================="
          echo "ğŸ‰ æˆåŠŸæ¨é€åˆ° Gistï¼"
          echo "=========================================="
          echo ""
          echo "ğŸ“ Gist åœ°å€:"
          echo "   https://gist.github.com/${GIST_ID}"
