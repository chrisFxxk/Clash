name: Sync Remote Rules to Gist

on:
  schedule:
    - cron: '10 0 * * *'
  workflow_dispatch:
  push:
    paths:
      - '.github/rules-urls.txt'
    branches:
      - main

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          persist-credentials: false
      
      - name: é…ç½® Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
      
      - name: å…‹éš† Gist
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: ${{ secrets.REMOTE_CLASH_RULES_GIST_ID }}
        run: |
          git clone https://${GIST_TOKEN}@gist.github.com/${GIST_ID}.git gist-repo
      
      - name: ä¸‹è½½è¿œç¨‹è§„åˆ™æ–‡ä»¶ï¼ˆæ™ºèƒ½å‘½åï¼‰
        run: |
          CONFIG_FILE=".github/rules-urls.txt"
          
          echo "=========================================="
          echo "ğŸŒ å¼€å§‹ä¸‹è½½è¿œç¨‹è§„åˆ™æ–‡ä»¶"
          echo "=========================================="
          echo ""
          
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CONFIG_FILE"
            exit 1
          fi
          
          echo "ğŸ“‹ è¯»å–é…ç½®æ–‡ä»¶: $CONFIG_FILE"
          echo ""
          
          SUCCESS=0
          FAILED=0
          SKIPPED=0
          
          mkdir -p /tmp/downloaded_rules
          
          # ç”¨äºè·Ÿè¸ªæ–‡ä»¶åå†²çª
          declare -A filename_map
          
          while IFS= read -r line || [ -n "$line" ]; do
            url=$(echo "$line" | xargs)
            
            [[ -z "$url" || "$url" =~ ^# ]] && continue
            
            # ä»URLä¸­æå–åŸºç¡€æ–‡ä»¶å
            base_filename=$(basename "$url" | cut -d'?' -f1)
            
            # ä»URLä¸­æå–è·¯å¾„ä¿¡æ¯ç”¨äºåŒºåˆ†
            # ä¾‹å¦‚: geo/geosite/cn.mrs -> geosite-cn.mrs
            #       geo/geoip/cn.mrs -> geoip-cn.mrs
            url_path=$(echo "$url" | sed 's|https\?://[^/]*/||' | sed 's|/[^/]*$||')
            
            # æ™ºèƒ½ç”Ÿæˆæ–‡ä»¶å
            if [[ "$url_path" =~ geoip ]]; then
              # geoip æ–‡ä»¶æ·»åŠ  geoip- å‰ç¼€
              final_filename="geoip-${base_filename}"
            elif [[ "$url_path" =~ geosite ]]; then
              # geosite æ–‡ä»¶æ·»åŠ  geosite- å‰ç¼€
              final_filename="geosite-${base_filename}"
            else
              # å…¶ä»–æ–‡ä»¶ä¿æŒåŸå
              final_filename="$base_filename"
            fi
            
            # æ£€æŸ¥æ–‡ä»¶åæ˜¯å¦å·²å­˜åœ¨
            if [[ -n "${filename_map[$final_filename]}" ]]; then
              echo "âš ï¸  è­¦å‘Š: æ–‡ä»¶åå†²çª $final_filename"
              echo "   URL1: ${filename_map[$final_filename]}"
              echo "   URL2: $url"
              echo "   å°†ä½¿ç”¨è®¡æ•°åç¼€"
              
              # æ·»åŠ è®¡æ•°åç¼€
              count=2
              temp_filename="${final_filename%.*}_${count}.${final_filename##*.}"
              while [[ -n "${filename_map[$temp_filename]}" ]]; do
                count=$((count + 1))
                temp_filename="${final_filename%.*}_${count}.${final_filename##*.}"
              done
              final_filename="$temp_filename"
            fi
            
            # è®°å½•æ–‡ä»¶åæ˜ å°„
            filename_map[$final_filename]="$url"
            
            echo "ğŸ“¥ ä¸‹è½½: $final_filename"
            if [[ "$final_filename" != "$base_filename" ]]; then
              echo "   åŸå: $base_filename"
            fi
            echo "   URL: $url"
            
            if curl -fsSL -o "/tmp/downloaded_rules/$final_filename" "$url" --connect-timeout 30 --max-time 120; then
              if [ -s "/tmp/downloaded_rules/$final_filename" ]; then
                cp "/tmp/downloaded_rules/$final_filename" "gist-repo/$final_filename"
                size=$(du -h "gist-repo/$final_filename" | cut -f1)
                echo "   âœ“ æˆåŠŸ ($size)"
                SUCCESS=$((SUCCESS + 1))
              else
                echo "   âš  æ–‡ä»¶ä¸ºç©ºï¼Œè·³è¿‡"
                rm -f "/tmp/downloaded_rules/$final_filename"
                SKIPPED=$((SKIPPED + 1))
              fi
            else
              echo "   âœ— ä¸‹è½½å¤±è´¥"
              FAILED=$((FAILED + 1))
            fi
            
            echo ""
          done < "$CONFIG_FILE"
          
          echo "=========================================="
          echo "ğŸ“Š ä¸‹è½½ç»Ÿè®¡"
          echo "=========================================="
          echo "  âœ“ æˆåŠŸ: $SUCCESS"
          echo "  âœ— å¤±è´¥: $FAILED"
          echo "  âš  è·³è¿‡: $SKIPPED"
          echo "=========================================="
      
      - name: æ¸…ç† Gist ä¸­çš„è¿‡æœŸæ–‡ä»¶
        run: |
          CONFIG_FILE=".github/rules-urls.txt"
          
          echo ""
          echo "ğŸ—‘ï¸  æ¸…ç† Gist ä¸­çš„è¿‡æœŸæ–‡ä»¶..."
          echo ""
          
          cd gist-repo
          
          DELETED=0
          
          # ç”Ÿæˆé¢„æœŸçš„æ–‡ä»¶åˆ—è¡¨ï¼ˆåº”ç”¨ç›¸åŒçš„å‘½åè§„åˆ™ï¼‰
          EXPECTED_FILES=""
          while IFS= read -r line || [ -n "$line" ]; do
            url=$(echo "$line" | xargs)
            [[ -z "$url" || "$url" =~ ^# ]] && continue
            
            base_filename=$(basename "$url" | cut -d'?' -f1)
            url_path=$(echo "$url" | sed 's|https\?://[^/]*/||' | sed 's|/[^/]*$||')
            
            if [[ "$url_path" =~ geoip ]]; then
              final_filename="geoip-${base_filename}"
            elif [[ "$url_path" =~ geosite ]]; then
              final_filename="geosite-${base_filename}"
            else
              final_filename="$base_filename"
            fi
            
            EXPECTED_FILES="${EXPECTED_FILES}${final_filename}"$'\n'
          done < "../$CONFIG_FILE"
          
          # æ£€æŸ¥å¹¶åˆ é™¤ä¸åœ¨åˆ—è¡¨ä¸­çš„æ–‡ä»¶
          for gist_file in $(find . -type f -not -path "./.git/*" | sed 's|^\./||'); do
            if ! echo "$EXPECTED_FILES" | grep -qx "$gist_file"; then
              rm -f "$gist_file"
              echo "  âœ— å·²åˆ é™¤: $gist_file ï¼ˆæœªåœ¨é…ç½®ä¸­ï¼‰"
              DELETED=$((DELETED + 1))
            fi
          done
          
          cd ..
          
          if [ $DELETED -eq 0 ]; then
            echo "  â„¹ï¸  æ— éœ€åˆ é™¤"
          else
            echo ""
            echo "  ğŸ“Š å…±åˆ é™¤ $DELETED ä¸ªæ–‡ä»¶"
          fi
      
      - name: æ˜¾ç¤ºåŒæ­¥ç»“æœ
        working-directory: ./gist-repo
        run: |
          echo ""
          echo "=========================================="
          echo "ğŸ“¦ Gist ä¸­çš„è§„åˆ™æ–‡ä»¶"
          echo "=========================================="
          echo ""
          
          if [ -n "$(ls -A . 2>/dev/null | grep -v '^\.git$')" ]; then
            find . -type f -not -path "./.git/*" | sort | while read file; do
              filename=$(basename "$file")
              size=$(du -h "$file" | cut -f1)
              lines=$(wc -l < "$file" 2>/dev/null || echo "0")
              echo "  ğŸ“„ $filename"
              echo "     å¤§å°: $size | è¡Œæ•°: $lines"
            done
          else
            echo "  (æ— æ–‡ä»¶)"
          fi
          
          echo ""
          FILE_COUNT=$(find . -type f -not -path "./.git/*" | wc -l)
          TOTAL_SIZE=$(du -sh . 2>/dev/null | cut -f1)
          
          echo "=========================================="
          echo "ğŸ“Š ç»Ÿè®¡ä¿¡æ¯"
          echo "=========================================="
          echo "  æ–‡ä»¶æ•°é‡: $FILE_COUNT"
          echo "  æ€»å¤§å°: $TOTAL_SIZE"
          echo "=========================================="
      
      - name: æäº¤æ›´æ”¹
        working-directory: ./gist-repo
        run: |
          git add -A
          
          if git diff --staged --quiet; then
            echo ""
            echo "â„¹ï¸  è§„åˆ™æ–‡ä»¶æ— å˜æ›´ï¼Œè·³è¿‡æ¨é€"
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
          else
            echo ""
            echo "ğŸ“ æ£€æµ‹åˆ°å˜æ›´ï¼Œå‡†å¤‡æäº¤..."
            
            ADDED=$(git diff --staged --name-only --diff-filter=A | wc -l)
            MODIFIED=$(git diff --staged --name-only --diff-filter=M | wc -l)
            DELETED=$(git diff --staged --name-only --diff-filter=D | wc -l)
            
            git commit -m "Sync: +$ADDED ~$MODIFIED -$DELETED @ $(date -u '+%Y-%m-%d %H:%M')"
            echo "HAS_CHANGES=true" >> $GITHUB_ENV
          fi
      
      - name: æ¨é€åˆ° Gist
        if: env.HAS_CHANGES == 'true'
        working-directory: ./gist-repo
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: ${{ secrets.REMOTE_CLASH_RULES_GIST_ID }}
        run: |
          git remote set-url origin https://${GIST_TOKEN}@gist.github.com/${GIST_ID}.git
          git pull --rebase origin master 2>/dev/null || git pull --rebase origin main
          git push origin HEAD
          
          echo ""
          echo "=========================================="
          echo "ğŸ‰ æˆåŠŸæ¨é€åˆ° Gistï¼"
          echo "=========================================="
          echo ""
          echo "ğŸ“ Gist åœ°å€:"
          echo "   https://gist.github.com/${GIST_ID}"
          echo ""
          echo "â° ä¸‹æ¬¡è‡ªåŠ¨åŒæ­¥: æ˜å¤© 0:10 UTC (åŒ—äº¬æ—¶é—´ 8:10)"
          echo "=========================================="
