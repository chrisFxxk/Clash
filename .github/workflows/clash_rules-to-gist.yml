name: Sync Clash Rules Files to Gist

on:
  # 文件更新时立即推送
  push:
    paths:
      - 'my_Alstudio.list'
      - 'my_Direct.list'
      - 'my_Emby_69.list'
      - 'my_Gmail.list'
      - 'my_Grok.list'
      - 'my_Notebooklm.list'
      - 'my_Perplexity.list'
      - 'my_Proxy.list'
      - 'my_Proxyip.list'
      - 'my_US.list'
      - 'my_Video.list'

    branches:
      - main  # 如果你的默认分支是 master，改成 master
  
  # 支持手动触发
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4
        with:
          persist-credentials: false
      
      - name: 配置 Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
      
      - name: 克隆 Gist
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: ${{ secrets.CLASH_RULES_GIST_ID }}  # 替换为第一步获取的 Gist ID
        run: |
          git clone https://${GIST_TOKEN}@gist.github.com/${GIST_ID}.git gist-repo
      
      - name: 复制文件到 Gist
        run: |
          cp my_Alstudio.list gist-repo/ 2>/dev/null || echo "my_Alstudio.list not found"
          cp my_Direct.list gist-repo/ 2>/dev/null || echo "my_Direct.list not found"
          cp my_Emby_69.list gist-repo/ 2>/dev/null || echo "my_Emby_69.list not found"
          cp my_Gmail.list gist-repo/ 2>/dev/null || echo "my_Gmail.list not found"
          cp my_Grok.list gist-repo/ 2>/dev/null || echo "my_Grok.list not found"
          cp my_Notebooklm.list gist-repo/ 2>/dev/null || echo "my_Notebooklm.list not found"
          cp my_Perplexity.list gist-repo/ 2>/dev/null || echo "my_Perplexity.list not found"
          cp my_Proxy.list gist-repo/ 2>/dev/null || echo "my_Proxy.list not found"
          cp my_Proxyip.list gist-repo/ 2>/dev/null || echo "my_Proxyip.list not found"
          cp my_US.list gist-repo/ 2>/dev/null || echo "my_US.list not found"
          cp my_Video.list gist-repo/ 2>/dev/null || echo "my_Video.list not found"
      
      - name: 提交更改
        working-directory: ./gist-repo
        run: |
          git add -A
          
          if git diff --staged --quiet; then
            echo "没有变更，跳过"
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
          else
            git commit -m "Auto-sync at $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "HAS_CHANGES=true" >> $GITHUB_ENV
          fi
      
      - name: 推送到 Gist
        if: env.HAS_CHANGES == 'true'
        working-directory: ./gist-repo
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: ${{ secrets.CLASH_RULES_GIST_ID }}  # 与上面相同的 Gist ID
        run: |
          git remote set-url origin https://${GIST_TOKEN}@gist.github.com/${GIST_ID}.git
          git pull --rebase origin master || git pull --rebase origin main
          git push origin HEAD
