name: Sync Remote Rules to Gist

on:
  # æ¯å¤©0ç‚¹10åˆ†æ‰§è¡Œ
  schedule:
    - cron: '10 0 * * *'  # UTC æ—¶é—´ 0:10ï¼ŒåŒ—äº¬æ—¶é—´ 8:10
  
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # é…ç½®æ–‡ä»¶æ›´æ–°æ—¶ä¹Ÿè§¦å‘
  push:
    paths:
      - '.github/rules-urls.txt'
    branches:
      - main

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          persist-credentials: false
      
      - name: é…ç½® Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
      
      - name: å…‹éš† Gist
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: ${{ secrets.REMOTE_CLASH_RULES_GIST_ID }}
        run: |
          git clone https://${GIST_TOKEN}@gist.github.com/${GIST_ID}.git gist-repo
      
      - name: ä¸‹è½½è¿œç¨‹è§„åˆ™æ–‡ä»¶
        run: |
          CONFIG_FILE=".github/rules-urls.txt"
          
          echo "=========================================="
          echo "ğŸŒ å¼€å§‹ä¸‹è½½è¿œç¨‹è§„åˆ™æ–‡ä»¶"
          echo "=========================================="
          echo ""
          
          # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CONFIG_FILE"
            echo ""
            echo "è¯·åˆ›å»ºé…ç½®æ–‡ä»¶å¹¶æ·»åŠ è§„åˆ™æ–‡ä»¶çš„URL"
            exit 1
          fi
          
          echo "ğŸ“‹ è¯»å–é…ç½®æ–‡ä»¶: $CONFIG_FILE"
          echo ""
          
          SUCCESS=0
          FAILED=0
          SKIPPED=0
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p /tmp/downloaded_rules
          
          # è¯»å–é…ç½®æ–‡ä»¶ï¼Œä¸‹è½½æ¯ä¸ªURL
          while IFS= read -r line || [ -n "$line" ]; do
            # å»é™¤å‰åç©ºæ ¼
            url=$(echo "$line" | xargs)
            
            # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Šè¡Œ
            [[ -z "$url" || "$url" =~ ^# ]] && continue
            
            # ä»URLä¸­æå–æ–‡ä»¶å
            filename=$(basename "$url")
            
            # å¦‚æœURLåŒ…å«æŸ¥è¯¢å‚æ•°ï¼Œå»é™¤å®ƒä»¬
            filename=$(echo "$filename" | cut -d'?' -f1)
            
            echo "ğŸ“¥ ä¸‹è½½: $filename"
            echo "   URL: $url"
            
            # ä½¿ç”¨ curl ä¸‹è½½æ–‡ä»¶
            if curl -fsSL -o "/tmp/downloaded_rules/$filename" "$url" --connect-timeout 30 --max-time 120; then
              # éªŒè¯æ–‡ä»¶ä¸ä¸ºç©º
              if [ -s "/tmp/downloaded_rules/$filename" ]; then
                # å¤åˆ¶åˆ° Gist ç›®å½•
                cp "/tmp/downloaded_rules/$filename" "gist-repo/$filename"
                
                # è·å–æ–‡ä»¶å¤§å°
                size=$(du -h "gist-repo/$filename" | cut -f1)
                echo "   âœ“ æˆåŠŸ ($size)"
                SUCCESS=$((SUCCESS + 1))
              else
                echo "   âš  æ–‡ä»¶ä¸ºç©ºï¼Œè·³è¿‡"
                rm -f "/tmp/downloaded_rules/$filename"
                SKIPPED=$((SKIPPED + 1))
              fi
            else
              echo "   âœ— ä¸‹è½½å¤±è´¥"
              FAILED=$((FAILED + 1))
            fi
            
            echo ""
          done < "$CONFIG_FILE"
          
          echo "=========================================="
          echo "ğŸ“Š ä¸‹è½½ç»Ÿè®¡"
          echo "=========================================="
          echo "  âœ“ æˆåŠŸ: $SUCCESS"
          echo "  âœ— å¤±è´¥: $FAILED"
          echo "  âš  è·³è¿‡: $SKIPPED"
          echo "=========================================="
      
      - name: æ¸…ç† Gist ä¸­çš„è¿‡æœŸæ–‡ä»¶
        run: |
          CONFIG_FILE=".github/rules-urls.txt"
          
          echo ""
          echo "ğŸ—‘ï¸  æ¸…ç† Gist ä¸­çš„è¿‡æœŸæ–‡ä»¶..."
          echo ""
          
          cd gist-repo
          
          DELETED=0
          
          # ä»é…ç½®æ–‡ä»¶ä¸­æå–æ‰€æœ‰æ–‡ä»¶å
          EXPECTED_FILES=$(grep -v '^#' "../$CONFIG_FILE" | grep -v '^$' | xargs -I {} basename {} | cut -d'?' -f1)
          
          # æ£€æŸ¥ Gist ä¸­çš„æ¯ä¸ªæ–‡ä»¶
          for gist_file in $(find . -type f -not -path "./.git/*" | sed 's|^\./||'); do
            # æ£€æŸ¥è¯¥æ–‡ä»¶æ˜¯å¦åœ¨é¢„æœŸåˆ—è¡¨ä¸­
            if ! echo "$EXPECTED_FILES" | grep -q "^${gist_file}$"; then
              rm -f "$gist_file"
              echo "  âœ— å·²åˆ é™¤: $gist_file ï¼ˆæœªåœ¨é…ç½®ä¸­ï¼‰"
              DELETED=$((DELETED + 1))
            fi
          done
          
          cd ..
          
          if [ $DELETED -eq 0 ]; then
            echo "  â„¹ï¸  æ— éœ€åˆ é™¤"
          else
            echo ""
            echo "  ğŸ“Š å…±åˆ é™¤ $DELETED ä¸ªæ–‡ä»¶"
          fi
      
      - name: æ˜¾ç¤ºåŒæ­¥ç»“æœ
        working-directory: ./gist-repo
        run: |
          echo ""
          echo "=========================================="
          echo "ğŸ“¦ Gist ä¸­çš„è§„åˆ™æ–‡ä»¶"
          echo "=========================================="
          echo ""
          
          if [ -n "$(ls -A . 2>/dev/null | grep -v '^\.git$')" ]; then
            find . -type f -not -path "./.git/*" | while read file; do
              filename=$(basename "$file")
              size=$(du -h "$file" | cut -f1)
              lines=$(wc -l < "$file" 2>/dev/null || echo "0")
              echo "  ğŸ“„ $filename"
              echo "     å¤§å°: $size | è¡Œæ•°: $lines"
            done
          else
            echo "  (æ— æ–‡ä»¶)"
          fi
          
          echo ""
          FILE_COUNT=$(find . -type f -not -path "./.git/*" | wc -l)
          TOTAL_SIZE=$(du -sh . 2>/dev/null | cut -f1)
          
          echo "=========================================="
          echo "ğŸ“Š ç»Ÿè®¡ä¿¡æ¯"
          echo "=========================================="
          echo "  æ–‡ä»¶æ•°é‡: $FILE_COUNT"
          echo "  æ€»å¤§å°: $TOTAL_SIZE"
          echo "=========================================="
      
      - name: æäº¤æ›´æ”¹
        working-directory: ./gist-repo
        run: |
          git add -A
          
          if git diff --staged --quiet; then
            echo ""
            echo "â„¹ï¸  è§„åˆ™æ–‡ä»¶æ— å˜æ›´ï¼Œè·³è¿‡æ¨é€"
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
          else
            echo ""
            echo "ğŸ“ æ£€æµ‹åˆ°å˜æ›´ï¼Œå‡†å¤‡æäº¤..."
            
            ADDED=$(git diff --staged --name-only --diff-filter=A | wc -l)
            MODIFIED=$(git diff --staged --name-only --diff-filter=M | wc -l)
            DELETED=$(git diff --staged --name-only --diff-filter=D | wc -l)
            
            # åˆ›å»ºè¯¦ç»†çš„æäº¤ä¿¡æ¯
            cat > /tmp/commit_msg.txt << 'EOF'
          Auto-sync rules at $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          Changes: +ADDED_COUNT ~MODIFIED_COUNT -DELETED_COUNT
          EOF
            
            # æ›¿æ¢å ä½ç¬¦
            sed -i "s/\$(date -u '+%Y-%m-%d %H:%M:%S UTC')/$(date -u '+%Y-%m-%d %H:%M:%S UTC')/g" /tmp/commit_msg.txt
            sed -i "s/ADDED_COUNT/${ADDED}/g" /tmp/commit_msg.txt
            sed -i "s/MODIFIED_COUNT/${MODIFIED}/g" /tmp/commit_msg.txt
            sed -i "s/DELETED_COUNT/${DELETED}/g" /tmp/commit_msg.txt
            
            # æ·»åŠ å˜æ›´è¯¦æƒ…
            if [ $ADDED -gt 0 ]; then
              echo "" >> /tmp/commit_msg.txt
              echo "Added:" >> /tmp/commit_msg.txt
              git diff --staged --name-only --diff-filter=A | sed 's/^/  - /' >> /tmp/commit_msg.txt
            fi
            
            if [ $MODIFIED -gt 0 ]; then
              echo "" >> /tmp/commit_msg.txt
              echo "Modified:" >> /tmp/commit_msg.txt
              git diff --staged --name-only --diff-filter=M | sed 's/^/  - /' >> /tmp/commit_msg.txt
            fi
            
            if [ $DELETED -gt 0 ]; then
              echo "" >> /tmp/commit_msg.txt
              echo "Deleted:" >> /tmp/commit_msg.txt
              git diff --staged --name-only --diff-filter=D | sed 's/^/  - /' >> /tmp/commit_msg.txt
            fi
            
            git commit -F /tmp/commit_msg.txt
            rm /tmp/commit_msg.txt
            
            echo "HAS_CHANGES=true" >> $GITHUB_ENV
          fi
      
      - name: æ¨é€åˆ° Gist
        if: env.HAS_CHANGES == 'true'
        working-directory: ./gist-repo
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: ${{ secrets.REMOTE_CLASH_RULES_GIST_ID }}
        run: |
          git remote set-url origin https://${GIST_TOKEN}@gist.github.com/${GIST_ID}.git
          git pull --rebase origin master 2>/dev/null || git pull --rebase origin main
          git push origin HEAD
          
          echo ""
          echo "=========================================="
          echo "ğŸ‰ æˆåŠŸæ¨é€åˆ° Gistï¼"
          echo "=========================================="
          echo ""
          echo "ğŸ“ Gist åœ°å€:"
          echo "   https://gist.github.com/${GIST_ID}"
          echo ""
          echo "â° ä¸‹æ¬¡è‡ªåŠ¨åŒæ­¥: æ˜å¤© 0:10 UTC (åŒ—äº¬æ—¶é—´ 8:10)"
          echo "=========================================="
